# E-Commerce ì„œë¹„ìŠ¤ ì¥ì•  ëŒ€ì‘ ë§¤ë‰´ì–¼

**ë¬¸ì„œ ë²„ì „**: v1.1
**ì‘ì„±ì¼**: 2026-02-26
**ìµœì¢… ìˆ˜ì •ì¼**: 2026-02-26
**ì‘ì„±ì**: ë°±ì—”ë“œ ê°œë°œíŒ€

---

## 1. ê°œìš”

### 1.1 ë¬¸ì„œ ëª©ì 

ë³¸ ë¬¸ì„œëŠ” E-Commerce ì„œë¹„ìŠ¤ ìš´ì˜ ì¤‘ ë°œìƒí•  ìˆ˜ ìˆëŠ” ì¥ì•  ìƒí™©ì— ëŒ€í•œ ëŒ€ì‘ ì ˆì°¨ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
ë¶€í•˜ í…ŒìŠ¤íŠ¸ ë° ì½”ë“œ ë¶„ì„ì„ í†µí•´ ì‹ë³„ëœ ë³‘ëª© ì§€ì ê³¼ ì˜ˆìƒ ê°€ëŠ¥í•œ ì¥ì•  ì‹œë‚˜ë¦¬ì˜¤ì— ëŒ€í•œ ëŒ€ì‘ ë°©ì•ˆì„ ì œê³µí•©ë‹ˆë‹¤.

### 1.2 ëŒ€ìƒ ë…ì

- ë°±ì—”ë“œ ê°œë°œíŒ€
- DevOps/SRE íŒ€
- ì„œë¹„ìŠ¤ ìš´ì˜íŒ€

### 1.3 ì‹œìŠ¤í…œ êµ¬ì„± ìš”ì•½

| ì»´í¬ë„ŒíŠ¸ | ê¸°ìˆ  ìŠ¤íƒ | ì—­í•  |
|---------|----------|------|
| WAS | Spring Boot 3.4.1 (Java 17) | ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì²˜ë¦¬ |
| Database | MySQL 8.0 | ë°ì´í„° ì˜êµ¬ ì €ì¥ |
| Cache | Redis 7-alpine | ë¶„ì‚°ë½, ë©±ë“±ì„± í‚¤, ìºì‹± |
| Message Broker | Apache Kafka 7.5.0 | ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¬ë° |

### 1.4 í˜„ì¬ ì‹œìŠ¤í…œ í•œê³„ ë° ìˆ˜ìš©ëŸ‰

#### ë¦¬ì†ŒìŠ¤ ì œì•½ (í˜„ì¬ ì„¤ì • ê¸°ì¤€)

| ë¦¬ì†ŒìŠ¤ | í˜„ì¬ ì„¤ì • | ì œì•½ ì˜í–¥ |
|--------|----------|----------|
| HikariCP Pool Size | **3ê°œ** | ë™ì‹œ DB ìš”ì²­ 3ê°œë¡œ ì œí•œ |
| Connection Timeout | 10ì´ˆ | 4ë²ˆì§¸ ìš”ì²­ë¶€í„° 10ì´ˆ ëŒ€ê¸° |
| ë¶„ì‚°ë½ ëŒ€ê¸° ì‹œê°„ | 10ì´ˆ ê³ ì • | ê³ íŠ¸ë˜í”½ ì‹œ ëŒ€ê¸°ì—´ ë°œìƒ |
| Async Thread Pool | ë¬´ì œí•œ | OOM ìœ„í—˜ |
| Redis Connection Pool | 100ê°œ | ë¹„êµì  ì—¬ìœ  |

#### ê¸°ëŠ¥ë³„ ì˜ˆìƒ ì²˜ë¦¬ëŸ‰ (í˜„ì¬ ì„¤ì • ê¸°ì¤€)

| ê¸°ëŠ¥ | ìµœëŒ€ ë™ì‹œ ì²˜ë¦¬ | ë³‘ëª© ìš”ì¸ | ê¶Œì¥ ë™ì‹œ ìš”ì²­ |
|------|--------------|----------|--------------|
| ìƒí’ˆ ì¡°íšŒ | ~3 TPS | DB Connection Pool | 2 TPS |
| í¬ì¸íŠ¸ ì¡°íšŒ | ~3 TPS | DB Connection Pool | 2 TPS |
| í¬ì¸íŠ¸ ì¶©ì „ | ~1 TPS | ë¶„ì‚°ë½ ì§ë ¬í™” | 1 TPS |
| ì£¼ë¬¸ ìƒì„± | ~1 TPS | ë¶„ì‚°ë½ + ê¸´ íŠ¸ëœì­ì…˜ | 1 TPS |
| ê²°ì œ ì²˜ë¦¬ | ~1 TPS | ë¶„ì‚°ë½ + ì—¬ëŸ¬ ë„ë©”ì¸ ì ‘ê·¼ | 1 TPS |
| ì¿ í° ë°œí–‰ | ~10 TPS | Redis ê¸°ë°˜ (ì›ìì„± ë¬¸ì œ) | 5 TPS |
| ì¸ê¸° ìƒí’ˆ ì¡°íšŒ | ~10 TPS | Redis ìºì‹œ | 10 TPS |

#### ë¶€í•˜ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½ (Smoke Test ê¸°ì¤€)

| ì§€í‘œ | ì¸¡ì •ê°’ | ë¹„ê³  |
|------|--------|------|
| ì´ ìš”ì²­ ìˆ˜ | 302ê±´/ë¶„ | 3 VUs, 1ë¶„ |
| í‰ê·  ì‘ë‹µ ì‹œê°„ | 22.34ms | ëª©í‘œ ë‹¬ì„± |
| p95 ì‘ë‹µ ì‹œê°„ | 61.08ms | ëª©í‘œ 2000ms ëŒ€ë¹„ ì–‘í˜¸ |
| ì—ëŸ¬ìœ¨ | 79.80% | API íŒŒì‹± ë¬¸ì œë¡œ ë†’ìŒ |
| ì¸ê¸° ìƒí’ˆ ì¡°íšŒ ì„±ê³µë¥  | 100% | Redis ìºì‹œ í™œìš© |

> **ì£¼ì˜**: í˜„ì¬ ì„¤ì •ì€ ê°œë°œ/í…ŒìŠ¤íŠ¸ í™˜ê²½ ìˆ˜ì¤€ì…ë‹ˆë‹¤. í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œëŠ” HikariCP Pool Sizeë¥¼ 15-20ìœ¼ë¡œ, ë¶„ì‚°ë½ ëŒ€ê¸° ì‹œê°„ì„ 3-5ì´ˆë¡œ ì¡°ì •í•´ì•¼ í•©ë‹ˆë‹¤.

#### ì˜ˆìƒ Breaking Point

| ì‹œë‚˜ë¦¬ì˜¤ | ì˜ˆìƒ í•œê³„ | ì¦ìƒ |
|----------|----------|------|
| ë™ì‹œ ì£¼ë¬¸ | 3-4ëª… | Connection Pool ê³ ê°ˆ, íƒ€ì„ì•„ì›ƒ |
| ë™ì‹œ í¬ì¸íŠ¸ ì¶©ì „ | 10ëª…/ì´ˆ | Lock ëŒ€ê¸° ëˆ„ì , ì‘ë‹µ ì§€ì—° |
| ë™ì‹œ ì¿ í° ë°œí–‰ | 100ëª…/ì´ˆ | ê³¼ë°œí–‰ ê°€ëŠ¥ì„± |
| ì „ì²´ íŠ¸ë˜í”½ | ~10 VUs | ì „ë°˜ì ì¸ ì‘ë‹µ ì§€ì—° |

---

## 2. ì‹œìŠ¤í…œ ë³‘ëª© ì§€ì  ë¶„ì„

### 2.1 ë³‘ëª© ì§€ì  ìš”ì•½

| ìš°ì„ ìˆœìœ„ | ë³‘ëª© ì§€ì  | ì‹¬ê°ë„ | ì˜í–¥ ë²”ìœ„ | ìœ„ì¹˜ |
|---------|----------|--------|---------|------|
| 1 | HikariCP Pool Size (3ê°œ) | CRITICAL | ëª¨ë“  DB ì‘ì—… | `application.yml:10` |
| 2 | PlaceOrderService ê¸´ íŠ¸ëœì­ì…˜ | CRITICAL | ì£¼ë¬¸ ì‹œìŠ¤í…œ | `PlaceOrderService.java` |
| 3 | Async ìŠ¤ë ˆë“œ í’€ ë¬´ì œí•œ | HIGH | ë©”ëª¨ë¦¬/CPU | `AsyncConfig.java` |
| 4 | Point Pessimistic Lock ë¹„í™œì„±í™” | HIGH | í¬ì¸íŠ¸ ì¶©ì „ | `PointJpaRepository.java` |
| 5 | ë¶„ì‚°ë½ 10ì´ˆ íƒ€ì„ì•„ì›ƒ ê³ ì • | MEDIUM-HIGH | ì£¼ë¬¸/ì¶©ì „ | `DeductedStockService.java` |
| 6 | Kafka Consumer DLQ ë¯¸êµ¬í˜„ | MEDIUM-HIGH | ì´ë²¤íŠ¸ ì²˜ë¦¬ | `CouponKafkaConsumer.java` |

### 2.2 ìƒì„¸ ë¶„ì„

#### 2.2.1 HikariCP Connection Pool Size (CRITICAL)

**í˜„ì¬ ì„¤ì •**:
```yaml
# application.yml
spring:
  datasource:
    hikari:
      maximum-pool-size: 3    # ê¸°ë³¸ê°’ 10ë³´ë‹¤ ë§¤ìš° ë‚®ìŒ
      connection-timeout: 10000
      max-lifetime: 60000
```

**ë¬¸ì œì **:
- ë™ì‹œ 4ê°œ ì´ìƒì˜ DB ìš”ì²­ ì‹œ ì¦‰ì‹œ Connection ëŒ€ê¸° ë°œìƒ
- ì£¼ë¬¸ API í˜¸ì¶œ ì‹œ ë‚´ë¶€ì ìœ¼ë¡œ ì—¬ëŸ¬ DB ì‘ì—…ì´ ë°œìƒí•˜ì—¬ Pool ê³ ê°ˆ ê°€ì†í™”
- Connection ëŒ€ê¸° íƒ€ì„ì•„ì›ƒ(10ì´ˆ) ì´ˆê³¼ ì‹œ ì˜ˆì™¸ ë°œìƒ

**ì˜í–¥**:
- ë™ì‹œ ì‚¬ìš©ì 10ëª… ì´ìƒ ì‹œ ì‘ë‹µ ì§€ì—° ê¸‰ì¦
- `HikariPool-1 - Connection is not available` ì˜ˆì™¸ ë°œìƒ

**ê¶Œì¥ ê°œì„ **:
```yaml
hikari:
  maximum-pool-size: 20       # ì˜ˆìƒ ë™ì‹œ ì‚¬ìš©ì ìˆ˜ ê³ ë ¤
  minimum-idle: 5             # ìµœì†Œ ìœ íœ´ ì—°ê²° ìœ ì§€
  connection-timeout: 30000   # 30ì´ˆë¡œ ì¦ê°€
```

---

#### 2.2.2 PlaceOrderService ê¸´ íŠ¸ëœì­ì…˜ (CRITICAL)

**í˜„ì¬ êµ¬ì¡°**:
```
PlaceOrderService.order() [@Transactional]
â”œâ”€â”€ memberRepository.retrieve()           # DB ì¡°íšŒ
â”œâ”€â”€ productRepository.findByIds()         # DB ì¡°íšŒ
â”œâ”€â”€ deductedStockUseCase.deductedStock()  # ë¶„ì‚°ë½(10ì´ˆ) + DB
â”œâ”€â”€ orderRepository.save()                # DB ì €ì¥
â”œâ”€â”€ registerOrderProductUseCase.register() # DB ì €ì¥
â””â”€â”€ registerPaymentUseCase.registerPaymentInfo() # DB ì €ì¥
```

**ë¬¸ì œì **:
- ë‹¨ì¼ íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ ë¶„ì‚°ë½ íšë“ ì‹œë„ (ìµœëŒ€ 10ì´ˆ ëŒ€ê¸°)
- íŠ¸ëœì­ì…˜ ì§€ì† ì‹œê°„: ë¶„ì‚°ë½ ëŒ€ê¸° + 5ê°œ ì´ìƒ DB ì‘ì—…
- Connection Pool ì ìœ  ì‹œê°„ ê¸¸ì–´ì§ â†’ Pool ê³ ê°ˆ ìœ ë°œ

**ì˜í–¥**:
- 10ëª… ë™ì‹œ ì£¼ë¬¸ ì‹œ ì¼ë¶€ ìš”ì²­ íƒ€ì„ì•„ì›ƒ
- Lock íšë“ ì‹¤íŒ¨ ì‹œ ì „ì²´ íŠ¸ëœì­ì…˜ ë¡¤ë°±

---

#### 2.2.3 Async ìŠ¤ë ˆë“œ í’€ ë¯¸ì„¤ì • (HIGH)

**í˜„ì¬ ì„¤ì •**:
```java
// AsyncConfig.java
@Configuration
@EnableAsync
public class AsyncConfig {
    // ì»¤ìŠ¤í…€ Executor ë¯¸ì •ì˜
}
```

**ë¬¸ì œì **:
- `SimpleAsyncTaskExecutor` ì‚¬ìš© (ê¸°ë³¸ê°’)
- ìš”ì²­ë§ˆë‹¤ ìƒˆ ìŠ¤ë ˆë“œ ìƒì„± â†’ ìŠ¤ë ˆë“œ ìˆ˜ ì œí•œ ì—†ìŒ
- ëŒ€ëŸ‰ ìš”ì²­ ì‹œ OOM(OutOfMemory) ë°œìƒ ê°€ëŠ¥

**ë¹„ë™ê¸° ì‚¬ìš© ìœ„ì¹˜**:
- `RegisterPopularProductService.registerPopularProducts()`
- `PaymentDataTransportService.send()`
- `PaymentEventListener.onPaymentEvent()`

**ê¶Œì¥ ê°œì„ **:
```java
@Bean
public TaskExecutor taskExecutor() {
    ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
    executor.setCorePoolSize(10);
    executor.setMaxPoolSize(50);
    executor.setQueueCapacity(100);
    executor.setThreadNamePrefix("async-");
    executor.setRejectedExecutionHandler(new CallerRunsPolicy());
    return executor;
}
```

---

#### 2.2.4 Point Pessimistic Lock ë¹„í™œì„±í™” (HIGH)

**í˜„ì¬ ìƒíƒœ**:
```java
// PointJpaRepository.java - ì£¼ì„ ì²˜ë¦¬ë¨
// @Lock(LockModeType.PESSIMISTIC_WRITE)
// @Query("select p from PointJpaEntity p where p.memberId = :memberId")
// Optional<PointJpaEntity> findByMemberIdForUpdate(@Param("memberId") Long memberId);
```

**ë¬¸ì œì **:
- Pessimistic Lockì´ ë¹„í™œì„±í™”ë˜ì–´ DB ë ˆë²¨ ë™ì‹œì„± ì œì–´ ì—†ìŒ
- Redisson ë¶„ì‚°ë½ë§Œ ì˜ì¡´ â†’ Redis ì¥ì•  ì‹œ Race Condition ë°œìƒ ê°€ëŠ¥

**ì˜í–¥**:
- Redis ì¥ì•  ì‹œ í¬ì¸íŠ¸ ì¤‘ë³µ ì°¨ê°/ì¶©ì „ ê°€ëŠ¥ì„±
- ë°ì´í„° ì •í•©ì„± ë³´ì¥ ë¶ˆê°€

---

#### 2.2.5 ë¶„ì‚°ë½ íƒ€ì„ì•„ì›ƒ ê³ ì • (MEDIUM-HIGH)

**í˜„ì¬ ì„¤ì •**:
```java
// DeductedStockService.java, ChargePointService.java
boolean available = lock.tryLock(10, -1, TimeUnit.SECONDS);
// 10ì´ˆ ëŒ€ê¸°, watchdog ìë™ ì—°ì¥
```

**ë¬¸ì œì **:
- ê³ ì • 10ì´ˆ ëŒ€ê¸° â†’ ê³ íŠ¸ë˜í”½ ìƒí™©ì—ì„œ ëŒ€ë¶€ë¶„ íƒ€ì„ì•„ì›ƒ
- Lock íšë“ ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ ë¡œì§ ì—†ìŒ
- í´ë¼ì´ì–¸íŠ¸ì—ê²Œ `IllegalStateException` ì „ë‹¬ (500 ì—ëŸ¬)

---

#### 2.2.6 Kafka Consumer DLQ ë¯¸êµ¬í˜„ (MEDIUM-HIGH)

**í˜„ì¬ ìƒíƒœ**:
```java
// CouponKafkaConsumer.java
@Retryable(maxAttempts = 3, backoff = @Backoff(delay = 1000))
@KafkaListener(topics = "coupon-issued", groupId = "coupon-group")
public void consume(String message) {
    // 3ë²ˆ ì¬ì‹œë„ í›„ ì‹¤íŒ¨ ì‹œ ë©”ì‹œì§€ ìœ ì‹¤
}
```

**ë¬¸ì œì **:
- ì¬ì‹œë„ 3íšŒ ì‹¤íŒ¨ ì‹œ ë©”ì‹œì§€ ì˜êµ¬ ì†ì‹¤
- Dead Letter Queue(DLQ) ë¯¸êµ¬í˜„
- ì‹¤íŒ¨ ë©”ì‹œì§€ ì¶”ì  ë¶ˆê°€

---

#### 2.2.7 ì¿ í° ë°œí–‰ ì›ìì„± ë¶€ì¬ (HIGH)

**í˜„ì¬ ì½”ë“œ**:
```java
// IssueCouponService.java
// 1. ì¤‘ë³µ ë°œí–‰ ì²´í¬
Boolean isCouponIssue = redisUtil.setIfAbsent(
    "coupon:" + couponId + ":member:" + memberId, "1", duration);

// 2. ì¿ í° ê°œìˆ˜ ì°¨ê° (ì›ìì„± ì—†ìŒ)
redisUtil.decrement("coupon:" + couponId);

// 3. ê²€ì¦ (ê²½í•© ìœˆë„ìš° ì¡´ì¬)
String amount = redisUtil.get("coupon:" + couponId);
if (Integer.parseInt(amount) < 0) {
    redisUtil.increment("coupon:" + couponId);  // ë¡¤ë°±
    throw new Exception();
}
```

**ë¬¸ì œì **:
- `decrement` â†’ `get` â†’ ê²€ì¦ ì‚¬ì´ì— ê²½í•© ìœˆë„ìš° ì¡´ì¬
- ë™ì‹œ 100ê°œ ìš”ì²­ ì‹œ 101ê°œ ì´ìƒ ë°œí–‰ ê°€ëŠ¥ (ê³¼ë°œí–‰)
- `increment` ë¡¤ë°±ì€ ê²½í•© ìƒí™©ì—ì„œ ë¶ˆì™„ì „

**ì˜í–¥**:
- ì¿ í° ê³¼ë°œí–‰ìœ¼ë¡œ ì¸í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ì†ì‹¤
- ë°ì´í„° ì •í•©ì„± ë³´ì¥ ë¶ˆê°€

**ê¶Œì¥ ê°œì„ **:
```lua
-- Redis Lua ìŠ¤í¬ë¦½íŠ¸ë¡œ ì›ìì„± ë³´ì¥
local key = KEYS[1]
local memberKey = KEYS[2]
local current = tonumber(redis.call('GET', key) or 0)

if current <= 0 then
    return -1  -- ìˆ˜ëŸ‰ ë¶€ì¡±
end

if redis.call('EXISTS', memberKey) == 1 then
    return -2  -- ì´ë¯¸ ë°œí–‰ë¨
end

redis.call('DECR', key)
redis.call('SET', memberKey, '1', 'EX', ARGV[1])
return current - 1
```

---

#### 2.2.8 Kafka ì „ì†¡ ì‹¤íŒ¨ ë¬´ì‹œ (HIGH)

**í˜„ì¬ ì½”ë“œ**:
```java
// PaymentKafkaProducer.java
public void send(PaymentEvent event) {
    CompletableFuture<SendResult<String, PaymentEvent>> future =
        kafkaTemplate.send(PAYMENT_COMPLETED_TOPIC, key, event);

    future.whenComplete((result, ex) -> {
        if (ex != null) {
            log.error("ê²°ì œ ì´ë²¤íŠ¸ Kafka ì „ì†¡ ì‹¤íŒ¨");
            // âš ï¸ ì˜ˆì™¸ ë¬´ì‹œ - ì¬ì‹œë„ ì—†ìŒ, ë©”ì‹œì§€ ì†ì‹¤
        }
    });
}
```

**ë¬¸ì œì **:
- Fire-and-forget ë°©ì‹ìœ¼ë¡œ ì „ì†¡ ì‹¤íŒ¨ ë¬´ì‹œ
- Outboxì— ì €ì¥ë˜ì—ˆìœ¼ë‚˜ Kafka ì „ì†¡ ì‹¤íŒ¨ ì‹œ ì´ë²¤íŠ¸ ì†ì‹¤
- ë¹„ë™ê¸° ì½œë°± ë‚´ ì˜ˆì™¸ ì²˜ë¦¬ ë¯¸í¡

**ì˜í–¥**:
- ê²°ì œ ì™„ë£Œ í›„ í›„ì† ì²˜ë¦¬(ë°ì´í„° í”Œë«í¼ ì „ì†¡ ë“±) ëˆ„ë½
- ë¹„ì¦ˆë‹ˆìŠ¤ í”„ë¡œì„¸ìŠ¤ ë¶ˆì™„ì „

**ê¶Œì¥ ê°œì„ **:
```java
// DLQ ë° ì¬ì‹œë„ ì •ì±… ì ìš©
public void send(PaymentEvent event) {
    try {
        SendResult<String, PaymentEvent> result =
            kafkaTemplate.send(topic, key, event).get(5, TimeUnit.SECONDS);
        log.info("Kafka ì „ì†¡ ì„±ê³µ: offset={}", result.getRecordMetadata().offset());
    } catch (Exception e) {
        log.error("Kafka ì „ì†¡ ì‹¤íŒ¨, DLQë¡œ ì´ë™: {}", e.getMessage());
        kafkaTemplate.send(DLQ_TOPIC, key, event);
    }
}
```

---

#### 2.2.9 Outbox íŠ¸ëœì­ì…˜ ë¶„ë¦¬ (MEDIUM)

**í˜„ì¬ êµ¬ì¡°**:
```java
// PaymentFacade.java
@Transactional
public PaymentResponse payment(PaymentRequest request, String idempotencyKey) {
    PaymentResponse response = paymentUseCase.payment(request, idempotencyKey);

    // Outbox ì €ì¥ (PROPAGATION_REQUIRES_NEW - ë³„ë„ íŠ¸ëœì­ì…˜)
    registerOutboxUseCase.register(new Outbox(...));

    // ì´ë²¤íŠ¸ ë°œí–‰
    eventPublisher.publishEvent(new PaymentEvent(...));

    return response;
}
```

**ë¬¸ì œì **:
- Outboxê°€ `REQUIRES_NEW`ë¡œ ë³„ë„ íŠ¸ëœì­ì…˜ ì‹¤í–‰
- ë©”ì¸ íŠ¸ëœì­ì…˜ ì„±ê³µ + Outbox íŠ¸ëœì­ì…˜ ì‹¤íŒ¨ ê°€ëŠ¥
- ê²°ì œëŠ” ì™„ë£Œë˜ì—ˆìœ¼ë‚˜ ì´ë²¤íŠ¸ ë°œí–‰ ê¸°ë¡ ì—†ìŒ

**ì˜í–¥**:
- Outbox ê¸°ë°˜ ì´ë²¤íŠ¸ ì¬ë°œí–‰ ë¶ˆê°€
- ì¥ì•  ë³µêµ¬ ì‹œ ëˆ„ë½ëœ ì´ë²¤íŠ¸ ì¶”ì  ì–´ë ¤ì›€

**ê¶Œì¥ ê°œì„ **:
```java
// ë™ì¼ íŠ¸ëœì­ì…˜ìœ¼ë¡œ í†µí•©
@Transactional
public PaymentResponse payment(PaymentRequest request, String idempotencyKey) {
    PaymentResponse response = paymentUseCase.payment(request, idempotencyKey);

    // ê°™ì€ íŠ¸ëœì­ì…˜ì—ì„œ Outbox ì €ì¥
    outboxRepository.save(new Outbox(...));

    return response;
}

// TransactionalEventListenerë¡œ ì»¤ë°‹ í›„ ì´ë²¤íŠ¸ ë°œí–‰
@TransactionalEventListener(phase = AFTER_COMMIT)
public void onPaymentComplete(PaymentCompleteEvent event) {
    kafkaProducer.send(event);
}
```

---

#### 2.2.10 Redis-DB ë¹„ë™ê¸° ë™ê¸°í™” (MEDIUM)

**í˜„ì¬ êµ¬ì¡°**:
```
IssueCouponService (Redis ê¸°ë°˜ ë°œí–‰)
  â†“ (ì´ë²¤íŠ¸ ë°œí–‰)
CouponIssueEventListener (@Async)
  â†“ (Kafka ì „ì†¡)
CouponKafkaConsumer (ì¬ì‹œë„ 3íšŒ)
  â†“ (DBì— ê¸°ë¡)
CouponHistory ì €ì¥ + Coupon.amount ì°¨ê°
```

**ë¬¸ì œì **:
- Redisì—ì„œ ë°œí–‰ ì„±ê³µ + Kafka ì‹¤íŒ¨ = DBì— ë¯¸ê¸°ë¡
- Coupon.amount ì°¨ê°ì€ ë³„ë„ Kafka ë©”ì‹œì§€ë¡œ ì²˜ë¦¬
- CouponHistoryì™€ Coupon.amount ê°„ ë¶ˆì¼ì¹˜ ê°€ëŠ¥

**ì˜í–¥**:
- Redis ê¸°ì¤€ ë°œí–‰ ìˆ˜ â‰  DB ê¸°ì¤€ ë°œí–‰ ìˆ˜
- ì •ì‚°/í†µê³„ ë°ì´í„° ë¶ˆì¼ì¹˜

**ê¶Œì¥ ê°œì„ **:
- ì˜µì…˜ 1: ë™ê¸° ë°©ì‹ (Redis + DB ë™ì¼ íŠ¸ëœì­ì…˜)
- ì˜µì…˜ 2: Saga íŒ¨í„´ (ë³´ìƒ íŠ¸ëœì­ì…˜)
- ì˜µì…˜ 3: ì •ê¸° ë°°ì¹˜ë¡œ Redis-DB ë™ê¸°í™” ê²€ì¦

---

## 3. ë³‘ëª© ê°œì„  ë°©ì•ˆ

### 3.1 ë‹¨ê¸° ê°œì„  (ì¦‰ì‹œ ì ìš© ê°€ëŠ¥)

| í•­ëª© | í˜„ì¬ | ê¶Œì¥ | ë³€ê²½ íŒŒì¼ | ìš°ì„ ìˆœìœ„ |
|------|------|------|----------|---------|
| HikariCP pool-size | 3 | 15-20 | `application.yml` | ğŸ”´ ê¸´ê¸‰ |
| Connection timeout | 10ì´ˆ | 30ì´ˆ | `application.yml` | ğŸ”´ ê¸´ê¸‰ |
| Lock ëŒ€ê¸° ì‹œê°„ | 10ì´ˆ ê³ ì • | ì„¤ì • ì™¸ë¶€í™” | `application.yml` | ğŸŸ  ë†’ìŒ |
| ì¿ í° ë°œí–‰ ì›ìì„± | ë¹„ì›ìì  | Lua ìŠ¤í¬ë¦½íŠ¸ | `IssueCouponService.java` | ğŸ”´ ê¸´ê¸‰ |
| Kafka ì „ì†¡ ì‹¤íŒ¨ ì²˜ë¦¬ | ë¬´ì‹œ | DLQ + ì¬ì‹œë„ | `PaymentKafkaProducer.java` | ğŸ”´ ê¸´ê¸‰ |
| Async ThreadPool | ë¬´ì œí•œ | í’€ ì‚¬ì´ì¦ˆ ì œí•œ | `AsyncConfig.java` | ğŸŸ  ë†’ìŒ |

**application.yml ìˆ˜ì • ì˜ˆì‹œ**:
```yaml
spring:
  datasource:
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000
      max-lifetime: 1800000  # 30ë¶„

# ì»¤ìŠ¤í…€ ì„¤ì •
app:
  lock:
    wait-time: 15        # ë¶„ì‚°ë½ ëŒ€ê¸° ì‹œê°„(ì´ˆ)
    lease-time: -1       # watchdog ì‚¬ìš©
```

### 3.2 ì¤‘ê¸° ê°œì„  (ì„¤ê³„ ë³€ê²½ í•„ìš”)

#### 3.2.1 Async ThreadPool ì„¤ì • ì¶”ê°€

```java
@Configuration
@EnableAsync
public class AsyncConfig {

    @Bean("taskExecutor")
    public TaskExecutor taskExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(10);
        executor.setMaxPoolSize(50);
        executor.setQueueCapacity(100);
        executor.setThreadNamePrefix("async-");
        executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
        executor.initialize();
        return executor;
    }
}
```

#### 3.2.2 Kafka DLQ êµ¬í˜„

```java
@Bean
public ConcurrentKafkaListenerContainerFactory<String, String> kafkaListenerContainerFactory(
        ConsumerFactory<String, String> consumerFactory,
        KafkaTemplate<String, String> kafkaTemplate) {

    ConcurrentKafkaListenerContainerFactory<String, String> factory =
        new ConcurrentKafkaListenerContainerFactory<>();
    factory.setConsumerFactory(consumerFactory);

    // DLQ ì„¤ì •
    DeadLetterPublishingRecoverer recoverer =
        new DeadLetterPublishingRecoverer(kafkaTemplate);
    factory.setCommonErrorHandler(
        new DefaultErrorHandler(recoverer, new FixedBackOff(1000L, 3)));

    return factory;
}
```

### 3.3 ì¥ê¸° ê°œì„  (ì•„í‚¤í…ì²˜ ë³€ê²½)

#### 3.3.1 ì£¼ë¬¸ íŠ¸ëœì­ì…˜ ë¶„ë¦¬ (SAGA íŒ¨í„´)

```
í˜„ì¬: ë‹¨ì¼ íŠ¸ëœì­ì…˜
[ì£¼ë¬¸ìƒì„± + ì¬ê³ ì°¨ê° + ê²°ì œë“±ë¡] â†’ ì „ì²´ ì„±ê³µ or ì „ì²´ ì‹¤íŒ¨

ê°œì„ : ë¶„ë¦¬ëœ íŠ¸ëœì­ì…˜ + ë³´ìƒ íŠ¸ëœì­ì…˜
[ì£¼ë¬¸ìƒì„±] â†’ ì„±ê³µ â†’ [ì¬ê³ ì°¨ê°] â†’ ì„±ê³µ â†’ [ê²°ì œë“±ë¡]
     â†“              â†“              â†“
   ì‹¤íŒ¨ì‹œ         ì‹¤íŒ¨ì‹œ          ì‹¤íŒ¨ì‹œ
   ì¢…ë£Œ        ì£¼ë¬¸ì·¨ì†Œ ë³´ìƒ     ì¬ê³ ë³µêµ¬ + ì£¼ë¬¸ì·¨ì†Œ ë³´ìƒ
```

#### 3.3.2 Point Pessimistic Lock ì¬í™œì„±í™”

ë¶„ì‚°ë½ + DB ë½ ì´ì¤‘ ë³´í˜¸:
```java
// ë¶„ì‚°ë½ìœ¼ë¡œ 1ì°¨ ë³´í˜¸
RLock lock = redissonClient.getLock("point:lock:" + memberId);
if (lock.tryLock(waitTime, leaseTime, TimeUnit.SECONDS)) {
    try {
        // DB ë½ìœ¼ë¡œ 2ì°¨ ë³´í˜¸ (Redis ì¥ì•  ëŒ€ë¹„)
        Point point = pointRepository.findByMemberIdForUpdate(memberId);
        // ì¶©ì „ ë¡œì§
    } finally {
        lock.unlock();
    }
}
```

---

## 4. ì¥ì•  ìœ í˜•ë³„ ëŒ€ì‘ ë§¤ë‰´ì–¼

### 4.1 DB ì—°ê²° ê³ ê°ˆ (Connection Pool Exhaustion)

#### ì¦ìƒ
- ë¡œê·¸: `HikariPool-1 - Connection is not available, request timed out after 10000ms`
- API ì‘ë‹µ ì‹œê°„ ê¸‰ì¦ (10ì´ˆ ì´ìƒ)
- 500 Internal Server Error ì¦ê°€

#### ì›ì¸
1. Connection Pool Size ë¶€ì¡±
2. ê¸´ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì¸í•œ Connection ì ìœ 
3. Connection Leak (ë°˜í™˜ë˜ì§€ ì•ŠëŠ” ì—°ê²°)

#### ì¦‰ì‹œ ëŒ€ì‘
```bash
# 1. í˜„ì¬ DB ì—°ê²° ìƒíƒœ í™•ì¸
docker exec hhplus-mysql mysql -uroot -proot -e "SHOW PROCESSLIST;"

# 2. ì—°ê²° ìˆ˜ í™•ì¸
docker exec hhplus-mysql mysql -uroot -proot -e "SHOW STATUS LIKE 'Threads_connected';"

# 3. ê¸´ ì¿¼ë¦¬ í™•ì¸ ë° ì¢…ë£Œ
docker exec hhplus-mysql mysql -uroot -proot -e "
SELECT * FROM information_schema.processlist
WHERE TIME > 10 AND COMMAND != 'Sleep';
"

# íŠ¹ì • í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
docker exec hhplus-mysql mysql -uroot -proot -e "KILL <process_id>;"
```

#### ë³µêµ¬ ì ˆì°¨
1. ê¸´ ì¿¼ë¦¬/íŠ¸ëœì­ì…˜ ê°•ì œ ì¢…ë£Œ
2. í•„ìš”ì‹œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¬ì‹œì‘
3. Pool Size ì¦ê°€ (ì„¤ì • ë³€ê²½ í›„ ì¬ë°°í¬)

#### ì˜ˆë°© ì¡°ì¹˜
- Pool Size ëª¨ë‹ˆí„°ë§ ì•Œë¦¼ ì„¤ì • (80% ì´ˆê³¼ ì‹œ)
- íŠ¸ëœì­ì…˜ íƒ€ì„ì•„ì›ƒ ì„¤ì • ì¶”ê°€
- ì •ê¸°ì ì¸ Connection ìƒíƒœ ì ê²€

---

### 4.2 Redis ì¥ì• 

#### ì¦ìƒ
- ë¡œê·¸: `RedisConnectionException: Unable to connect to Redis`
- ë¶„ì‚°ë½ íšë“ ì‹¤íŒ¨ ê¸‰ì¦
- ê²°ì œ ì¤‘ë³µ ì²˜ë¦¬ ê°€ëŠ¥ì„±

#### ì›ì¸
1. Redis ì„œë²„ ë‹¤ìš´
2. ë„¤íŠ¸ì›Œí¬ ì—°ê²° ë¬¸ì œ
3. ë©”ëª¨ë¦¬ ë¶€ì¡±ìœ¼ë¡œ ì¸í•œ OOM

#### ì¦‰ì‹œ ëŒ€ì‘
```bash
# 1. Redis ìƒíƒœ í™•ì¸
docker exec hhplus-redis redis-cli ping
# ì •ìƒ: PONG

# 2. Redis ë©”ëª¨ë¦¬ í™•ì¸
docker exec hhplus-redis redis-cli INFO memory | grep used_memory_human

# 3. Redis ì—°ê²° ìˆ˜ í™•ì¸
docker exec hhplus-redis redis-cli INFO clients | grep connected_clients

# 4. Redis ì¬ì‹œì‘ (í•„ìš”ì‹œ)
docker restart hhplus-redis
```

#### ë³µêµ¬ ì ˆì°¨
1. Redis ì„œë²„ ìƒíƒœ í™•ì¸ ë° ì¬ì‹œì‘
2. ë„¤íŠ¸ì›Œí¬ ì—°ê²° ìƒíƒœ í™•ì¸
3. ë©”ëª¨ë¦¬ ë¶€ì¡± ì‹œ maxmemory ì •ì±… í™•ì¸

#### ì˜í–¥ ë²”ìœ„
| ê¸°ëŠ¥ | Redis ì¥ì•  ì‹œ ë™ì‘ |
|------|-------------------|
| í¬ì¸íŠ¸ ì¶©ì „ | ë¶„ì‚°ë½ ì‹¤íŒ¨ â†’ 500 ì—ëŸ¬ |
| ì¬ê³  ì°¨ê° | ë¶„ì‚°ë½ ì‹¤íŒ¨ â†’ 500 ì—ëŸ¬ |
| ê²°ì œ ì²˜ë¦¬ | ë©±ë“±ì„± ì²´í¬ ì‹¤íŒ¨ â†’ ì¤‘ë³µ ê²°ì œ ìœ„í—˜ |
| ì¸ê¸° ìƒí’ˆ | ìºì‹œ miss â†’ DB ì§ì ‘ ì¡°íšŒ |

#### Fallback ì „ëµ (ê¶Œì¥)
```java
// Redis ì¥ì•  ì‹œ DB ë½ìœ¼ë¡œ Fallback
try {
    lock = redissonClient.getLock(key);
    if (!lock.tryLock(waitTime, leaseTime, TimeUnit.SECONDS)) {
        // Fallback to DB Lock
        return executeWithDbLock(operation);
    }
} catch (RedisException e) {
    log.warn("Redis ì¥ì• , DB ë½ìœ¼ë¡œ ì „í™˜: {}", e.getMessage());
    return executeWithDbLock(operation);
}
```

---

### 4.3 Kafka ì¥ì• 

#### ì¦ìƒ
- ë¡œê·¸: `KafkaException: Failed to send message`
- ê²°ì œ ì™„ë£Œ ì´ë²¤íŠ¸ ë¯¸ì „ì†¡
- Outbox í…Œì´ë¸”ì— PENDING ìƒíƒœ ë©”ì‹œì§€ ëˆ„ì 

#### ì›ì¸
1. Kafka Broker ë‹¤ìš´
2. Topic ì„¤ì • ë¬¸ì œ
3. ë„¤íŠ¸ì›Œí¬ ì—°ê²° ë¬¸ì œ

#### ì¦‰ì‹œ ëŒ€ì‘
```bash
# 1. Kafka ìƒíƒœ í™•ì¸
docker exec hhplus-kafka kafka-broker-api-versions --bootstrap-server localhost:9092

# 2. Topic ëª©ë¡ í™•ì¸
docker exec hhplus-kafka kafka-topics --bootstrap-server localhost:9092 --list

# 3. Consumer Group ìƒíƒœ í™•ì¸
docker exec hhplus-kafka kafka-consumer-groups --bootstrap-server localhost:9092 --describe --group coupon-group

# 4. Kafka ì¬ì‹œì‘
docker restart hhplus-kafka
```

#### ë³µêµ¬ ì ˆì°¨
1. Kafka Broker ìƒíƒœ í™•ì¸ ë° ì¬ì‹œì‘
2. Outbox í…Œì´ë¸”ì˜ PENDING ë©”ì‹œì§€ ì¬ì²˜ë¦¬
3. Consumer Lag ëª¨ë‹ˆí„°ë§

#### Outbox ì¬ì²˜ë¦¬ ì¿¼ë¦¬
```sql
-- PENDING ìƒíƒœ ë©”ì‹œì§€ í™•ì¸
SELECT * FROM outbox WHERE status = 'PENDING' ORDER BY created_at;

-- ìˆ˜ë™ ì¬ì²˜ë¦¬ íŠ¸ë¦¬ê±° (ìŠ¤ì¼€ì¤„ëŸ¬ê°€ ì²˜ë¦¬)
UPDATE outbox SET retry_count = 0, status = 'PENDING'
WHERE status = 'FAILED' AND created_at > DATE_SUB(NOW(), INTERVAL 1 HOUR);
```

---

### 4.4 ë©”ëª¨ë¦¬ ë¶€ì¡± (OOM)

#### ì¦ìƒ
- ë¡œê·¸: `java.lang.OutOfMemoryError: Java heap space`
- ì• í”Œë¦¬ì¼€ì´ì…˜ ì‘ë‹µ ì—†ìŒ
- ì»¨í…Œì´ë„ˆ ìë™ ì¬ì‹œì‘

#### ì›ì¸
1. JVM Heap í¬ê¸° ë¶€ì¡±
2. ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ (Memory Leak)
3. ë¹„ë™ê¸° ìŠ¤ë ˆë“œ í­ì¦

#### ì¦‰ì‹œ ëŒ€ì‘
```bash
# 1. ì»¨í…Œì´ë„ˆ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ í™•ì¸
docker stats hhplus-app --no-stream

# 2. JVM ë©”ëª¨ë¦¬ ìƒíƒœ í™•ì¸ (Actuator í™œì„±í™” ì‹œ)
curl http://localhost:8080/actuator/metrics/jvm.memory.used

# 3. Heap Dump ìƒì„± (ì›ì¸ ë¶„ì„ìš©)
docker exec hhplus-app jmap -dump:format=b,file=/tmp/heapdump.hprof <PID>

# 4. ì• í”Œë¦¬ì¼€ì´ì…˜ ì¬ì‹œì‘
docker restart hhplus-app
```

#### ë³µêµ¬ ì ˆì°¨
1. ì• í”Œë¦¬ì¼€ì´ì…˜ ì¬ì‹œì‘ (ì¦‰ì‹œ ë³µêµ¬)
2. Heap Dump ë¶„ì„ (ì›ì¸ íŒŒì•…)
3. JVM ì˜µì…˜ ì¡°ì • ë˜ëŠ” ì½”ë“œ ìˆ˜ì •

#### JVM ì˜µì…˜ ê¶Œì¥ ì„¤ì •
```bash
JAVA_OPTS="-Xms512m -Xmx1024m -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/tmp"
```

---

### 4.5 ë¶„ì‚°ë½ íƒ€ì„ì•„ì›ƒ

#### ì¦ìƒ
- ë¡œê·¸: `Lock íšë“ ì‹¤íŒ¨: stock:lock:123`
- 500 Internal Server Error ì¦ê°€
- ì£¼ë¬¸/ì¶©ì „ ì‹¤íŒ¨ìœ¨ ê¸‰ì¦

#### ì›ì¸
1. ê³ íŠ¸ë˜í”½ìœ¼ë¡œ ì¸í•œ Lock ê²½ìŸ ì‹¬í™”
2. Lock ë³´ìœ  ì‹œê°„ ì´ˆê³¼
3. Redis ì§€ì—°

#### ì¦‰ì‹œ ëŒ€ì‘
```bash
# 1. Redisì—ì„œ í˜„ì¬ Lock ìƒíƒœ í™•ì¸
docker exec hhplus-redis redis-cli KEYS "*lock*"

# 2. íŠ¹ì • Lock ì •ë³´ í™•ì¸
docker exec hhplus-redis redis-cli GET "point:lock:1"

# 3. ê³ ì°©ëœ Lock ê°•ì œ ì‚­ì œ (ì£¼ì˜ í•„ìš”)
docker exec hhplus-redis redis-cli DEL "point:lock:1"
```

#### ë³µêµ¬ ì ˆì°¨
1. íŠ¸ë˜í”½ ìœ ì… ì œí•œ (Rate Limiting ì ìš©)
2. Lock ëŒ€ê¸° ì‹œê°„ ì„ì‹œ ì¦ê°€
3. ê³ ì°©ëœ Lock ìˆ˜ë™ í•´ì œ (ë°ì´í„° ì •í•©ì„± í™•ì¸ í›„)

---

### 4.6 ì¿ í° ê³¼ë°œí–‰ (Oversell)

#### ì¦ìƒ
- ë°œí–‰ëœ ì¿ í° ìˆ˜ > ì„¤ì •ëœ ìµœëŒ€ ìˆ˜ëŸ‰
- ì¿ í° ì”ì—¬ ìˆ˜ëŸ‰ì´ ìŒìˆ˜ë¡œ í‘œì‹œ
- ì •ì‚° ì‹œ ì¿ í° í• ì¸ ê¸ˆì•¡ ì˜ˆìƒ ì´ˆê³¼

#### ì›ì¸
1. Redis ì¿ í° ì°¨ê° ë¡œì§ì˜ ì›ìì„± ë¶€ì¬
2. ë™ì‹œ ë‹¤ë°œì  ì¿ í° ë°œí–‰ ìš”ì²­
3. decrement â†’ get â†’ ê²€ì¦ ì‚¬ì´ì˜ ê²½í•© ìœˆë„ìš°

#### ì¦‰ì‹œ ëŒ€ì‘
```bash
# 1. Redisì—ì„œ ì¿ í° ì”ì—¬ ìˆ˜ëŸ‰ í™•ì¸
docker exec hhplus-redis redis-cli GET "coupon:123"

# 2. ë°œí–‰ëœ ì¿ í° í‚¤ ìˆ˜ í™•ì¸
docker exec hhplus-redis redis-cli KEYS "coupon:123:member:*" | wc -l

# 3. DBì—ì„œ ì‹¤ì œ ë°œí–‰ ë‚´ì—­ í™•ì¸
docker exec hhplus-mysql mysql -uroot -proot -e "
SELECT COUNT(*) FROM coupon_history WHERE coupon_id = 123;
"

# 4. ê³¼ë°œí–‰ ìˆ˜ëŸ‰ ê³„ì‚°
# Redis ë°œí–‰ ìˆ˜ - DB ë°œí–‰ ìˆ˜ = ë¶ˆì¼ì¹˜ ê±´ìˆ˜
```

#### ë³µêµ¬ ì ˆì°¨
1. **ì¦‰ì‹œ**: í•´ë‹¹ ì¿ í° ë°œí–‰ API ì¼ì‹œ ì¤‘ë‹¨
2. **í™•ì¸**: Redisì™€ DB ê°„ ë¶ˆì¼ì¹˜ ë°ì´í„° ì‹ë³„
3. **ë³´ì •**: ê³¼ë°œí–‰ëœ ì¿ í° ë¬´íš¨í™” ì²˜ë¦¬
4. **í†µë³´**: ì˜í–¥ë°›ì€ ì‚¬ìš©ìì—ê²Œ ì•ˆë‚´

#### ë°ì´í„° ë³´ì • ì¿¼ë¦¬
```sql
-- ê³¼ë°œí–‰ëœ ì¿ í° ì‹ë³„ (ë°œí–‰ ì‹œê°„ ìˆœ ì •ë ¬, ì´ˆê³¼ë¶„ ë¬´íš¨í™”)
WITH RankedCoupons AS (
    SELECT id, member_id, created_at,
           ROW_NUMBER() OVER (ORDER BY created_at) as rn
    FROM coupon_history
    WHERE coupon_id = 123
)
UPDATE coupon_history
SET status = 'INVALIDATED', invalidated_reason = 'ê³¼ë°œí–‰ ë³´ì •'
WHERE id IN (
    SELECT id FROM RankedCoupons WHERE rn > 100  -- 100ê°œ ì´ˆê³¼ë¶„
);
```

#### ì˜ˆë°© ì¡°ì¹˜
- Redis Lua ìŠ¤í¬ë¦½íŠ¸ë¡œ ì›ìì  ë°œí–‰ ì²˜ë¦¬
- ë°œí–‰ ì „ ìˆ˜ëŸ‰ ê²€ì¦ ê°•í™”
- ë°œí–‰ í›„ DB ë™ê¸°í™” ê²€ì¦ ë°°ì¹˜

---

### 4.7 ì´ë²¤íŠ¸ ì†ì‹¤ (Event Loss)

#### ì¦ìƒ
- ê²°ì œ ì™„ë£Œ í›„ ë°ì´í„° í”Œë«í¼ì— ë°ì´í„° ë¯¸ì „ì†¡
- Outbox í…Œì´ë¸”ì— SENT ìƒíƒœì§€ë§Œ Kafkaì— ë©”ì‹œì§€ ì—†ìŒ
- Consumerì—ì„œ ì²˜ë¦¬ëœ ë©”ì‹œì§€ ìˆ˜ < Producer ë°œí–‰ ë©”ì‹œì§€ ìˆ˜

#### ì›ì¸
1. Kafka Producer ì „ì†¡ ì‹¤íŒ¨ ë¬´ì‹œ (Fire-and-forget)
2. Consumer ì¬ì‹œë„ 3íšŒ í›„ ë©”ì‹œì§€ íê¸°
3. DLQ(Dead Letter Queue) ë¯¸êµ¬í˜„
4. ë„¤íŠ¸ì›Œí¬ ì¼ì‹œì  ì¥ì• 

#### ì¦‰ì‹œ ëŒ€ì‘
```bash
# 1. Kafka Topic ë©”ì‹œì§€ ìˆ˜ í™•ì¸
docker exec hhplus-kafka kafka-run-class.sh kafka.tools.GetOffsetShell \
    --broker-list localhost:9092 \
    --topic payment-completed

# 2. Consumer Group Lag í™•ì¸
docker exec hhplus-kafka kafka-consumer-groups \
    --bootstrap-server localhost:9092 \
    --describe --group payment-consumer-group

# 3. Outbox í…Œì´ë¸” ìƒíƒœ í™•ì¸
docker exec hhplus-mysql mysql -uroot -proot -e "
SELECT status, COUNT(*) FROM outbox
WHERE created_at > DATE_SUB(NOW(), INTERVAL 1 HOUR)
GROUP BY status;
"

# 4. ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸ì—ì„œ ì „ì†¡ ì‹¤íŒ¨ í™•ì¸
docker logs hhplus-app 2>&1 | grep -i "kafka.*fail\|ì „ì†¡ ì‹¤íŒ¨"
```

#### ë³µêµ¬ ì ˆì°¨
1. **ì‹ë³„**: ì†ì‹¤ëœ ì´ë²¤íŠ¸ ëª©ë¡ ì¶”ì¶œ
2. **ì¬ë°œí–‰**: Outbox ê¸°ë°˜ ì´ë²¤íŠ¸ ì¬ìƒì„±
3. **ê²€ì¦**: Consumer ì²˜ë¦¬ ì™„ë£Œ í™•ì¸
4. **ëª¨ë‹ˆí„°ë§**: ì¶”ê°€ ì†ì‹¤ ì—¬ë¶€ ê°ì‹œ

#### ì´ë²¤íŠ¸ ì¬ë°œí–‰ ìŠ¤í¬ë¦½íŠ¸
```sql
-- ì†ì‹¤ ì˜ì‹¬ ì´ë²¤íŠ¸ ì‹ë³„
SELECT o.* FROM outbox o
LEFT JOIN (
    -- Kafka ì²˜ë¦¬ ì™„ë£Œ ë¡œê·¸ í…Œì´ë¸” (ìˆë‹¤ë©´)
    SELECT payload_id FROM kafka_processed_log
) k ON o.aggregate_id = k.payload_id
WHERE o.status = 'SENT'
  AND o.created_at > DATE_SUB(NOW(), INTERVAL 1 DAY)
  AND k.payload_id IS NULL;

-- ì¬ë°œí–‰ì„ ìœ„í•´ ìƒíƒœ ë³€ê²½
UPDATE outbox
SET status = 'PENDING', retry_count = 0
WHERE id IN (/* ì†ì‹¤ëœ ì´ë²¤íŠ¸ ID ëª©ë¡ */);
```

#### ì˜ˆë°© ì¡°ì¹˜
- Kafka Producer ë™ê¸° ì „ì†¡ ë˜ëŠ” ì½œë°± ì²˜ë¦¬ ê°•í™”
- DLQ êµ¬í˜„ ë° ëª¨ë‹ˆí„°ë§
- Outbox Scheduler ì£¼ê¸° ë‹¨ì¶•
- ì´ë²¤íŠ¸ ì²˜ë¦¬ ì™„ë£Œ ë¡œê¹…

---

### 4.8 ë°ì´í„° ë¶ˆì¼ì¹˜ (Data Inconsistency)

#### ì¦ìƒ
- Redis ìºì‹œ ë°ì´í„° â‰  DB ë°ì´í„°
- ì¿ í° ë°œí–‰ ìˆ˜ (Redis) â‰  ì¿ í° ì´ë ¥ ìˆ˜ (DB)
- í¬ì¸íŠ¸ ì”ì•¡ (ì¡°íšŒ) â‰  ì‹¤ì œ ì”ì•¡ (ê²°ì œ ì‹œ)
- ì¬ê³  ìˆ˜ëŸ‰ ë¶ˆì¼ì¹˜

#### ì›ì¸
1. Redis-DB ë¹„ë™ê¸° ë™ê¸°í™” ì‹¤íŒ¨
2. Kafka Consumer ì²˜ë¦¬ ì‹¤íŒ¨ í›„ ë©”ì‹œì§€ íê¸°
3. ë¶„ì‚° íŠ¸ëœì­ì…˜ ë¶€ë¶„ ì„±ê³µ/ì‹¤íŒ¨
4. ìºì‹œ ë¬´íš¨í™” ëˆ„ë½

#### ì¦‰ì‹œ ëŒ€ì‘
```bash
# 1. Redisì™€ DB ë°ì´í„° ë¹„êµ (ì¿ í° ì˜ˆì‹œ)
# Redis ì¿ í° ìˆ˜ëŸ‰
docker exec hhplus-redis redis-cli GET "coupon:123"

# DB ì¿ í° ìˆ˜ëŸ‰
docker exec hhplus-mysql mysql -uroot -proot -e "
SELECT amount FROM coupon WHERE id = 123;
"

# 2. í¬ì¸íŠ¸ ë¶ˆì¼ì¹˜ í™•ì¸
docker exec hhplus-mysql mysql -uroot -proot -e "
SELECT p.member_id, p.amount as current_point,
       (SELECT SUM(CASE WHEN type='CHARGE' THEN amount ELSE -amount END)
        FROM point_history WHERE member_id = p.member_id) as calculated_point
FROM point p
WHERE p.amount != (
    SELECT SUM(CASE WHEN type='CHARGE' THEN amount ELSE -amount END)
    FROM point_history WHERE member_id = p.member_id
);
"

# 3. ì¬ê³  ë¶ˆì¼ì¹˜ í™•ì¸
docker exec hhplus-mysql mysql -uroot -proot -e "
SELECT s.product_id, s.quantity as current_stock,
       (SELECT initial_stock - SUM(quantity)
        FROM order_product WHERE product_id = s.product_id) as calculated_stock
FROM stock s;
"
```

#### ë³µêµ¬ ì ˆì°¨
1. **ì„œë¹„ìŠ¤ ì¼ì‹œ ì¤‘ë‹¨**: ì¶”ê°€ ë¶ˆì¼ì¹˜ ë°©ì§€
2. **ë¶ˆì¼ì¹˜ ë²”ìœ„ íŒŒì•…**: ì˜í–¥ë°›ì€ ë°ì´í„° ì‹ë³„
3. **ë°ì´í„° ë³´ì •**: DB ê¸°ì¤€ìœ¼ë¡œ ìºì‹œ ë™ê¸°í™”
4. **ì›ì¸ ë¶„ì„**: ë¶ˆì¼ì¹˜ ë°œìƒ ì›ì¸ ì¶”ì 
5. **ì„œë¹„ìŠ¤ ì¬ê°œ**: ëª¨ë‹ˆí„°ë§ ê°•í™” í›„ ë³µêµ¬

#### ë°ì´í„° ë³´ì • ì ˆì°¨

**í¬ì¸íŠ¸ ë³´ì •**:
```sql
-- í¬ì¸íŠ¸ ì´ë ¥ ê¸°ë°˜ ì”ì•¡ ì¬ê³„ì‚°
UPDATE point p
SET amount = (
    SELECT COALESCE(SUM(
        CASE WHEN type = 'CHARGE' THEN amount ELSE -amount END
    ), 0)
    FROM point_history
    WHERE member_id = p.member_id
)
WHERE p.member_id IN (/* ë¶ˆì¼ì¹˜ íšŒì› ID ëª©ë¡ */);
```

**ì¿ í° ë³´ì •**:
```sql
-- ì¿ í° ë°œí–‰ ì´ë ¥ ê¸°ë°˜ ìˆ˜ëŸ‰ ì¬ê³„ì‚°
UPDATE coupon c
SET amount = c.initial_amount - (
    SELECT COUNT(*) FROM coupon_history
    WHERE coupon_id = c.id AND status = 'ISSUED'
)
WHERE c.id IN (/* ë¶ˆì¼ì¹˜ ì¿ í° ID ëª©ë¡ */);
```

**Redis ìºì‹œ ê°±ì‹ **:
```bash
# DB ê°’ìœ¼ë¡œ Redis ë™ê¸°í™”
docker exec hhplus-redis redis-cli SET "coupon:123" "50"
```

#### ì˜ˆë°© ì¡°ì¹˜
- ì •ê¸° ë°°ì¹˜ë¡œ Redis-DB ì •í•©ì„± ê²€ì¦
- ë¶ˆì¼ì¹˜ ê°ì§€ ì‹œ ì•Œë¦¼ ì„¤ì •
- íŠ¸ëœì­ì…˜ ë²”ìœ„ ìµœì†Œí™”
- Saga íŒ¨í„´ ë˜ëŠ” ë³´ìƒ íŠ¸ëœì­ì…˜ ë„ì…

---

## 5. ëª¨ë‹ˆí„°ë§ ë° ì•Œë¦¼ ì²´í¬ë¦¬ìŠ¤íŠ¸

### 5.1 í•µì‹¬ ëª¨ë‹ˆí„°ë§ ì§€í‘œ

| ì§€í‘œ | ì„ê³„ê°’ | ì•Œë¦¼ ë ˆë²¨ | í™•ì¸ ë°©ë²• |
|------|-------|----------|----------|
| HikariCP Active Connections | > 80% | WARNING | Actuator metrics |
| HikariCP Pending Threads | > 5 | CRITICAL | Actuator metrics |
| Redis ì—°ê²° ìˆ˜ | > 80 | WARNING | redis-cli INFO |
| Redis ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥  | > 80% | WARNING | redis-cli INFO |
| Kafka Consumer Lag | > 1000 | WARNING | kafka-consumer-groups |
| JVM Heap ì‚¬ìš©ë¥  | > 85% | WARNING | Actuator metrics |
| API ì—ëŸ¬ìœ¨ | > 1% | WARNING | ë¡œê·¸ ë¶„ì„ |
| API p99 ì‘ë‹µ ì‹œê°„ | > 2ì´ˆ | WARNING | ë¡œê·¸ ë¶„ì„ |

### 5.2 Docker ëª¨ë‹ˆí„°ë§ ëª…ë ¹ì–´

```bash
# ì „ì²´ ì»¨í…Œì´ë„ˆ ë¦¬ì†ŒìŠ¤ ëª¨ë‹ˆí„°ë§
docker stats --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}"

# íŠ¹ì • ì»¨í…Œì´ë„ˆ ë¡œê·¸ ì‹¤ì‹œê°„ í™•ì¸
docker logs -f hhplus-app --tail 100

# ì—ëŸ¬ ë¡œê·¸ë§Œ í•„í„°ë§
docker logs hhplus-app 2>&1 | grep -i "error\|exception"
```

### 5.3 Actuator ì—”ë“œí¬ì¸íŠ¸

```bash
# í—¬ìŠ¤ì²´í¬
curl http://localhost:8080/actuator/health

# HikariCP ë©”íŠ¸ë¦­
curl http://localhost:8080/actuator/metrics/hikaricp.connections.active
curl http://localhost:8080/actuator/metrics/hikaricp.connections.pending

# JVM ë©”íŠ¸ë¦­
curl http://localhost:8080/actuator/metrics/jvm.memory.used
curl http://localhost:8080/actuator/metrics/jvm.threads.live
```

---

## 6. ì¥ì•  ë³µêµ¬ ì ˆì°¨ (ì¢…í•©)

### 6.1 ì¥ì•  ëŒ€ì‘ í”Œë¡œìš°

```
ì¥ì•  ê°ì§€
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ì¥ì•  ìœ í˜• íŒŒì•…               â”‚
â”‚    - ë¡œê·¸ í™•ì¸                  â”‚
â”‚    - ëª¨ë‹ˆí„°ë§ ì§€í‘œ í™•ì¸         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ì˜í–¥ ë²”ìœ„ íŒŒì•…               â”‚
â”‚    - ì˜í–¥ë°›ëŠ” API ì‹ë³„          â”‚
â”‚    - ì‚¬ìš©ì ì˜í–¥ë„ í‰ê°€         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. ì¦‰ì‹œ ëŒ€ì‘                    â”‚
â”‚    - ê¸´ê¸‰ ë³µêµ¬ ì¡°ì¹˜ ìˆ˜í–‰        â”‚
â”‚    - í•„ìš”ì‹œ íŠ¸ë˜í”½ ì°¨ë‹¨         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ì›ì¸ ë¶„ì„                    â”‚
â”‚    - ë¡œê·¸ ìƒì„¸ ë¶„ì„             â”‚
â”‚    - ì¬í˜„ í…ŒìŠ¤íŠ¸                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. ì¬ë°œ ë°©ì§€                    â”‚
â”‚    - ê·¼ë³¸ ì›ì¸ í•´ê²°             â”‚
â”‚    - ëª¨ë‹ˆí„°ë§ ê°•í™”              â”‚
â”‚    - ë¬¸ì„œ ì—…ë°ì´íŠ¸              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 ê¸´ê¸‰ ì—°ë½ì²˜

| ì—­í•  | ë‹´ë‹¹ì | ì—°ë½ì²˜ |
|------|-------|-------|
| 1ì°¨ ëŒ€ì‘ | ë‹¹ì§ ê°œë°œì | (ì—°ë½ì²˜) |
| 2ì°¨ ì—ìŠ¤ì»¬ë ˆì´ì…˜ | ë°±ì—”ë“œ ë¦¬ë“œ | (ì—°ë½ì²˜) |
| ì¸í”„ë¼ ì§€ì› | DevOps íŒ€ | (ì—°ë½ì²˜) |

### 6.3 ì¥ì•  ë³´ê³ ì„œ í…œí”Œë¦¿

```markdown
## ì¥ì•  ë³´ê³ ì„œ

**ì¥ì•  ë°œìƒ ì¼ì‹œ**: YYYY-MM-DD HH:MM
**ì¥ì•  ë³µêµ¬ ì¼ì‹œ**: YYYY-MM-DD HH:MM
**ì¥ì•  ì§€ì† ì‹œê°„**: Xì‹œê°„ Xë¶„

### ì¥ì•  ê°œìš”
- ì¦ìƒ:
- ì˜í–¥ ë²”ìœ„:
- ì˜í–¥ ì‚¬ìš©ì ìˆ˜:

### íƒ€ì„ë¼ì¸
| ì‹œê°„ | ë‚´ìš© |
|------|------|
| HH:MM | ì¥ì•  ê°ì§€ |
| HH:MM | 1ì°¨ ëŒ€ì‘ |
| HH:MM | ë³µêµ¬ ì™„ë£Œ |

### ê·¼ë³¸ ì›ì¸
-

### ëŒ€ì‘ ë‚´ìš©
-

### ì¬ë°œ ë°©ì§€ ëŒ€ì±…
-
```

---

## 7. ë¯¸ì§€ì˜ ì¥ì•  ëŒ€ì‘ ê°€ì´ë“œ

ë³¸ ì„¹ì…˜ì€ ì˜ˆì¸¡í•˜ì§€ ëª»í•œ ì¥ì•  ìƒí™©ì—ì„œ ì²´ê³„ì ìœ¼ë¡œ ëŒ€ì‘í•˜ê¸° ìœ„í•œ ì¼ë°˜ì ì¸ ê°€ì´ë“œë¼ì¸ì„ ì œê³µí•©ë‹ˆë‹¤.

### 7.1 ì•Œ ìˆ˜ ì—†ëŠ” ì¥ì•  ê°ì§€ ì‹œ ì´ˆê¸° ëŒ€ì‘

#### Step 1: ìƒí™© íŒŒì•… (5ë¶„ ì´ë‚´)

```
â–¡ ì¥ì•  ë°œìƒ ì‹œê° ê¸°ë¡
â–¡ ì˜í–¥ë°›ëŠ” API/ê¸°ëŠ¥ ì‹ë³„
â–¡ ì—ëŸ¬ ë©”ì‹œì§€/ë¡œê·¸ ìˆ˜ì§‘
â–¡ ì‚¬ìš©ì ì˜í–¥ ë²”ìœ„ íŒŒì•…
â–¡ ìµœê·¼ ë°°í¬/ë³€ê²½ ì‚¬í•­ í™•ì¸
```

#### Step 2: ì‹œìŠ¤í…œ ìƒíƒœ ì ê²€ ì²´í¬ë¦¬ìŠ¤íŠ¸

```bash
# 1. ì „ì²´ ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
docker ps -a

# 2. ì»¨í…Œì´ë„ˆë³„ ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ í™•ì¸
docker stats --no-stream

# 3. ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ì²´í¬
curl -s http://localhost:8080/actuator/health | jq .

# 4. ìµœê·¼ ì—ëŸ¬ ë¡œê·¸ í™•ì¸
docker logs hhplus-app --since 5m 2>&1 | grep -i "error\|exception\|fail"

# 5. ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ìƒíƒœ
docker exec hhplus-mysql mysql -uroot -proot -e "SHOW STATUS LIKE 'Threads_connected';"

# 6. Redis ìƒíƒœ
docker exec hhplus-redis redis-cli ping

# 7. Kafka ìƒíƒœ
docker exec hhplus-kafka kafka-broker-api-versions --bootstrap-server localhost:9092 2>/dev/null && echo "OK" || echo "FAIL"
```

#### Step 3: ì¥ì•  ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜

| ì¦ìƒ | ì˜ì‹¬ ì˜ì—­ | í™•ì¸ í•­ëª© |
|------|----------|----------|
| ëª¨ë“  API ì‘ë‹µ ì§€ì—° | DB/Connection Pool | HikariCP ë©”íŠ¸ë¦­, DB ì—°ê²° ìƒíƒœ |
| íŠ¹ì • APIë§Œ ì‹¤íŒ¨ | í•´ë‹¹ ë„ë©”ì¸ ë¡œì§ | ê´€ë ¨ ì„œë¹„ìŠ¤ ë¡œê·¸, ë¶„ì‚°ë½ ìƒíƒœ |
| ê°„í—ì  500 ì—ëŸ¬ | ë¦¬ì†ŒìŠ¤ ê²½ìŸ/ë™ì‹œì„± | Lock ëŒ€ê¸°, íƒ€ì„ì•„ì›ƒ ì„¤ì • |
| ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ê¸‰ì¦ | ë©”ëª¨ë¦¬ ëˆ„ìˆ˜/GC | Heap ì‚¬ìš©ëŸ‰, ìŠ¤ë ˆë“œ ìˆ˜ |
| ì‘ë‹µ ì—†ìŒ (Hang) | ë°ë“œë½/ë¬´í•œ ë£¨í”„ | Thread Dump, DB Lock |
| ë°ì´í„° ì´ìƒ | ë™ì‹œì„±/íŠ¸ëœì­ì…˜ | ë°ì´í„° ì •í•©ì„± ê²€ì¦ |

### 7.2 ì—ìŠ¤ì»¬ë ˆì´ì…˜ ê¸°ì¤€

#### ì¦‰ì‹œ ì—ìŠ¤ì»¬ë ˆì´ì…˜ (ë°±ì—”ë“œ ë¦¬ë“œ)
- ì„œë¹„ìŠ¤ ì „ì²´ ì¤‘ë‹¨
- ê²°ì œ/í¬ì¸íŠ¸ ë°ì´í„° ì†ì‹¤ ë˜ëŠ” ë¶ˆì¼ì¹˜
- ë³µêµ¬ ì˜ˆìƒ ì‹œê°„ 30ë¶„ ì´ˆê³¼
- ì›ì¸ íŒŒì•… ë¶ˆê°€ (15ë¶„ ì´ìƒ)

#### ì¶”ê°€ ì—ìŠ¤ì»¬ë ˆì´ì…˜ (DevOps/ì¸í”„ë¼)
- ì¸í”„ë¼ ë ˆë²¨ ë¬¸ì œ (ì»¨í…Œì´ë„ˆ, ë„¤íŠ¸ì›Œí¬)
- ë°ì´í„°ë² ì´ìŠ¤ ë³µêµ¬ í•„ìš”
- ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³µêµ¬/ë³´ì • í•„ìš”

### 7.3 ë¡¤ë°± ê²°ì • ê¸°ì¤€

#### ì¦‰ì‹œ ë¡¤ë°± ì¡°ê±´
```
â–¡ ìƒˆ ë°°í¬ í›„ 5ë¶„ ì´ë‚´ ì¥ì•  ë°œìƒ
â–¡ ì—ëŸ¬ìœ¨ 5% ì´ìƒ ê¸‰ì¦
â–¡ ì´ì „ ë²„ì „ ì •ìƒ ë™ì‘ í™•ì¸ë¨
â–¡ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ì—†ëŠ” ë‹¨ìˆœ ì½”ë“œ ë³€ê²½
```

#### ë¡¤ë°± ì ˆì°¨
```bash
# 1. í˜„ì¬ ë²„ì „ í™•ì¸
docker inspect hhplus-app | grep Image

# 2. ì´ì „ ë²„ì „ìœ¼ë¡œ ë¡¤ë°±
docker stop hhplus-app
docker run -d --name hhplus-app-rollback [ì´ì „_ì´ë¯¸ì§€]

# 3. í—¬ìŠ¤ì²´í¬ í™•ì¸
curl http://localhost:8080/actuator/health

# 4. íŠ¸ë˜í”½ ì „í™˜
# (ë¡œë“œë°¸ëŸ°ì„œ ì„¤ì • ë³€ê²½ ë˜ëŠ” DNS ë³€ê²½)
```

#### ë¡¤ë°± ë¶ˆê°€ ì¡°ê±´
- DB ìŠ¤í‚¤ë§ˆ ë³€ê²½ í¬í•¨
- ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ
- ì™¸ë¶€ ì‹œìŠ¤í…œ ì—°ë™ ë³€ê²½

### 7.4 ê¸´ê¸‰ ë³µêµ¬ íŒ¨í„´

#### Pattern 1: ì¬ì‹œì‘ìœ¼ë¡œ í•´ê²°ë˜ëŠ” ê²½ìš°
```bash
# ì• í”Œë¦¬ì¼€ì´ì…˜ ì¬ì‹œì‘
docker restart hhplus-app

# ì „ì²´ ìŠ¤íƒ ì¬ì‹œì‘ (ìµœí›„ì˜ ìˆ˜ë‹¨)
docker-compose down && docker-compose up -d
```

#### Pattern 2: ë¦¬ì†ŒìŠ¤ ë¶€ì¡± í•´ê²°
```bash
# ì„ì‹œ ë©”ëª¨ë¦¬ í™•ì¥
docker update --memory 2g hhplus-app

# ì—°ê²° í’€ ë™ì  í™•ì¥ (ì¬ì‹œì‘ í•„ìš”)
# application.yml ìˆ˜ì • í›„ ì¬ë°°í¬
```

#### Pattern 3: íŠ¸ë˜í”½ ì œí•œ
```bash
# íŠ¹ì • API Rate Limiting (nginx ì˜ˆì‹œ)
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

# ë˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ì—ì„œ ì²˜ë¦¬
# @RateLimiter ì–´ë…¸í…Œì´ì…˜ ì¶”ê°€
```

#### Pattern 4: ì¥ì•  ê²©ë¦¬ (Circuit Breaker)
```java
// ì¥ì• ê°€ ë°œìƒí•œ ì™¸ë¶€ ì„œë¹„ìŠ¤ ê²©ë¦¬
@CircuitBreaker(name = "externalService", fallbackMethod = "fallback")
public Response callExternalService() {
    // ...
}

public Response fallback(Exception e) {
    log.warn("ì™¸ë¶€ ì„œë¹„ìŠ¤ ì¥ì• , ëŒ€ì²´ ì‘ë‹µ ë°˜í™˜");
    return Response.fallbackResponse();
}
```

### 7.5 ì‚¬í›„ ë¶„ì„ (Post-Mortem) ê°€ì´ë“œ

#### í•„ìˆ˜ ìˆ˜ì§‘ ì •ë³´
```
1. íƒ€ì„ë¼ì¸
   - ì¥ì•  ê°ì§€ ì‹œê°
   - ê° ëŒ€ì‘ ì¡°ì¹˜ ì‹œê°
   - ë³µêµ¬ ì™„ë£Œ ì‹œê°

2. ì˜í–¥ ë²”ìœ„
   - ì˜í–¥ë°›ì€ API/ê¸°ëŠ¥
   - ì—ëŸ¬ ê±´ìˆ˜/ë¹„ìœ¨
   - ì˜í–¥ë°›ì€ ì‚¬ìš©ì ìˆ˜

3. ê¸°ìˆ ì  ì¦ê±°
   - ê´€ë ¨ ë¡œê·¸ íŒŒì¼
   - ë©”íŠ¸ë¦­ ê·¸ë˜í”„ ìŠ¤í¬ë¦°ìƒ·
   - Thread Dump / Heap Dump

4. ì›ì¸ ë¶„ì„
   - ì§ì ‘ ì›ì¸ (Immediate Cause)
   - ê·¼ë³¸ ì›ì¸ (Root Cause)
   - ê¸°ì—¬ ìš”ì¸ (Contributing Factors)
```

#### ì¬ë°œ ë°©ì§€ ì•¡ì…˜ ì•„ì´í…œ ì˜ˆì‹œ
```
| ì•¡ì…˜ | ë‹´ë‹¹ì | ê¸°í•œ | ìš°ì„ ìˆœìœ„ |
|------|-------|------|---------|
| ëª¨ë‹ˆí„°ë§ ì•Œë¦¼ ì„ê³„ê°’ ì¡°ì • | - | - | ë†’ìŒ |
| Connection Pool ì‚¬ì´ì¦ˆ ì¦ê°€ | - | - | ê¸´ê¸‰ |
| íšŒê·€ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì¶”ê°€ | - | - | ì¤‘ê°„ |
| ë¬¸ì„œ ì—…ë°ì´íŠ¸ | - | - | ë‚®ìŒ |
```

### 7.6 ì¥ì•  ëŒ€ì‘ ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ í…œí”Œë¦¿

#### ì¥ì•  ë°œìƒ ì•Œë¦¼
```
[ì¥ì•  ë°œìƒ] E-Commerce ì„œë¹„ìŠ¤

â–  ë°œìƒ ì‹œê°: YYYY-MM-DD HH:MM
â–  ì˜í–¥ ë²”ìœ„: (ì˜í–¥ë°›ëŠ” ê¸°ëŠ¥)
â–  í˜„ì¬ ìƒíƒœ: ì¡°ì‚¬ ì¤‘ / ë³µêµ¬ ì¤‘
â–  ì˜ˆìƒ ë³µêµ¬ ì‹œê°„: í™•ì¸ ì¤‘

â€» ì¶”ê°€ ì •ë³´ëŠ” í™•ì¸ í›„ ê³µìœ  ì˜ˆì •
```

#### ë³µêµ¬ ì™„ë£Œ ì•Œë¦¼
```
[ë³µêµ¬ ì™„ë£Œ] E-Commerce ì„œë¹„ìŠ¤

â–  ì¥ì•  ì‹œê°„: HH:MM ~ HH:MM (ì´ Xë¶„)
â–  ì›ì¸: (ê°„ëµí•œ ì›ì¸)
â–  ì˜í–¥: (ì˜í–¥ ìš”ì•½)
â–  ì¡°ì¹˜: (ìˆ˜í–‰í•œ ì¡°ì¹˜)

â€» ìƒì„¸ ë¶„ì„ ë³´ê³ ì„œëŠ” ë³„ë„ ê³µìœ  ì˜ˆì •
```

---

## 8. ë³€ê²½ ì´ë ¥

| ë²„ì „ | ì¼ì | ì‘ì„±ì | ë³€ê²½ ë‚´ìš© |
|------|------|-------|----------|
| v1.0 | 2026-02-26 | ë°±ì—”ë“œ ê°œë°œíŒ€ | ì´ˆì•ˆ ì‘ì„± |
| v1.1 | 2026-02-26 | ë°±ì—”ë“œ ê°œë°œíŒ€ | ì¶”ê°€ ë³‘ëª© ì§€ì  ë¶„ì„ (ì¿ í° ì›ìì„±, Kafka ì „ì†¡ ì‹¤íŒ¨, Outbox íŠ¸ëœì­ì…˜, Redis-DB ë™ê¸°í™”), ìƒˆë¡œìš´ ì¥ì•  ìœ í˜• ì¶”ê°€ (ì¿ í° ê³¼ë°œí–‰, ì´ë²¤íŠ¸ ì†ì‹¤, ë°ì´í„° ë¶ˆì¼ì¹˜), ë¯¸ì§€ì˜ ì¥ì•  ëŒ€ì‘ ê°€ì´ë“œ ì„¹ì…˜ ì¶”ê°€, ì‹œìŠ¤í…œ ìˆ˜ìš©ëŸ‰ ì •ë³´ ì¶”ê°€ |

---

**ë¬¸ì„œ ë**
